# 서버측 구성

- 웹 접근 방식으로 간단하게 마이크로 프런트엔드를 구성할 수 있지만 개발이나 런타임 시점에 규모 변경이 힘들다.
- 규모 변경성에 대한 제약 없이 가능한 격리 및 분리하고 독립된 상태로 유지하려면 클라이언트에 도달하기 전에 웹서버가 마이크로 프론트엔드를 연결할 수 있는 서버측 구성(server-side composition) 패턴을 이용할 수 있다.
- 하지만 백엔드에 복잡성을 도입해야하기 때문에 다양한 소스의 뷰를 동적으로 결합하고 공유 저장소가 필요없는 수평적 마이크로 프런트엔드를 가능하게 하기위해 어떻게 적용해야하는지 알아보자.

## 서버측 구성의 기본

- 중앙 서버가 서로 다른 프런트엔드 프래그먼트들을 결합한다.
- 프래그먼트는 페이지의 완전히 구성된 부분만큼 클수도 이쏙, 일부 도멘인 로직을 가진 UI 컴포넌트만큼 작을 수도 있다.
- 리버스 프락시의 지점을 게이트웨이 서비스 또는 BFF 라고 한다.

### BFF(backend for frontend)

- 프런트엔드의 궁극적 목표는 화면을 그리는 일인데, 서비스를 도메인별로 분리시키고 독립적이고 단일 비즈니스 기능에 대한 책임만을 가지도록 하는 구조에서는 각 서비스가 가능별로 흩어져 있기 때문에 화면을 완성하기 위해 호출해야하는 서비스도 늘어나게 된다.
- 그래서 화면을 그리기 위해서는 다수의 서비스에 연동을 해야하며, 여러 서비스에 분산되어있는 데이터를 가져와서 적절히 합쳐야하는 경우도 발생하게 된다.
- 이를 돕기 위해 BFF가 존재하며 프론트엔드를 요구사항에 맞게 구현하기 위한 도움을 주는 보조서버이다.
- 프론트엔드의 로직을 중간 레이어를 두어 BFF에 위임하여 구체적인 구현 내용을 감추고 추상화된 API를 사용하여 프론트엔드에는 더 적은 로직이 남게 된다.
- BFF의 장점은 실제 비즈니스 로직의 구현과 응답 데이터를 클라이언트에서 요구되는 데이터로 파싱하는 두가지 관점을 분리하여 복잡도를 낮추고 필요한 작업에 집중하게 한다.

### 장점과 단점

- 서버측 구성은 규모 변경이 쉽고 느슨한 결합이며, 높은 성능을 자랑하기 때문에 마이크로 프론트엔드 구현에 가장 많이 사용되는 패턴중 하나로, 동적 발견, 독립적인 개발 및 수준 높은 유연성을 보장한다.
- 하지만 서로 다른 프론트엔드가 단일 페이지로 병합되므로 적절한 격리를 보장할 수 없어서 스크립트와 스타일시트가 서로 충돌하며, 적절한 디버깅 도구가 부족하여 충돌이 자주 발생할 수 있다.
- 서버측 구성이 좋은데도 불구하고 다른 패턴을 도입하는 이유는 어플리케이션을 구축하는 단일 페이지 어플리케이션 스타일이 잘 작동하지 않기 때문이다.

## 구성 레이아웃 만들기

- 게이트웨이는 대부분의 경우 리버스 프락시의 역할을 담당하지만 더 중요한 역할은 레이아웃이다.

### 레이아웃의 이해

- 레이아웃은 서로 다른 마이크로 프런트엔드에서 개별 프래그먼트를 어디에 배치할지 정한다.

1. 일반 레이아웃(generic layouts)

- 게이트웨이 서비스에 의해 정해진다. 하드코딩되거나 다른 서비스 또는 데이터베이스와 같은 일부 로직을 통해 결정할 수 있다.
- 머리글, 바닥글, 탐색 모음 및 내용을 결정할 수 있다.

2. 특정 레이아웃(specific layouts)

- 개별 마이크로 프런트엔드에 의해 정해진다. 그 후 다른 마이크로 프런트엔드에서 가져온 사이드바와 다른 마이크로 프론트엔드를 혼합하기 위해 다른 레이아웃을 사용한다.
- 게이트웨이 서비스만이 클라이어트로 다시 보낼 수 있는 일부 HTML을 생성하기 위해 레이아웃을 적적하게 리졸브해야하는 책임이 있어서 게이트웨이 서비스를 레이아웃 서비스 혹은 레이아웃 엔진이라고도 한다.
- 구조화 관점을 도입하기 위해 다양한 기술을 고려하여 ESI 와 같은 고급 기술을 지향한다.

### SSI

- 등장한지 오래되고 이미 확립된 기술이라 거의 모든 웹 서버에서 작동하며 지원되지 않는 우베 서버에서 사용하더락도 아무런 피해가 없다.
- 레이아웃을 실제로 생성하고 업데이트하는데 CMS 와 같은 기능을 제공하기 떄문에 빠르게 반복하고 수정할 수 있다.

### ESI

- SSI 에 비해 더 현대적이다. 더 풍부한 명령세트와 스크립팅 기능 외에더 쉬운 오류처리를 제공하며, 오류처리로 서버를 사용할 수 없는 경우 장애 조치를 취할 수 있다.
- varnish 또는 nginx와 같은 특수 리버스 프락시는 ESI를 사용할 때 고려되는 표준 웹서버로 구현하기 복잡하다.
- SSI 와 같으 레이아웃을 데이터베이스에 간단한 HTMl로 저장할 수 있어 개발자가 아닌 사용자가 레이아웃을 만들고 업데이트할 수 있다.

### JS 켐플릿 문자열 사용하기

- 모든 프로그래밍 언어에서 유연하게 문자열을 쉽게 정의할 수 있다.
- 하지만 전체 서비스를 업데이트 해야만 업데이트가 가능하기 때문에 빠른 반복과 개선을 하기 힘들다. 대신 레이아웃은 본질적으로 개발자가 배포하고 유지관리 해야하는 코드가 된다.

## 요약

- 서버측 구성을 사용하면 많은 리디렉션 및 성능 저하 없이 웹 접근 방식의 장점을 살릴 수 있다.
- 빠른 응답 시간과 자바스크립트 사용 감소가 중요한 정보 중심적 웹 어플리케이션에 적합하다.
- 설정의 복잡성과 필요한 인프라를 고려해야한다.
